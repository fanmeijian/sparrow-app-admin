import { InjectionToken } from "@angular/core";
import { BehaviorSubject, merge, map, of } from "rxjs";
export const TREE_SERVICE = new InjectionToken('treeService');
export class TreeDataSource {
    get data() {
        return this.dataChange.value;
    }
    set data(value) {
        this._treeControl.dataNodes = value;
        this.dataChange.next(value);
    }
    constructor(_treeControl, 
    // private _database: DynamicDatabase,
    treeService) {
        this._treeControl = _treeControl;
        this.treeService = treeService;
        this.dataChange = new BehaviorSubject([]);
        /** 节点缓存：key 为父节点 item，value 为其展开后的子节点列表 */
        this.nodeCache = new Map();
    }
    connect(collectionViewer) {
        this._treeControl.expansionModel.changed.subscribe(change => {
            if (change.added ||
                change.removed) {
                this.handleTreeControl(change);
            }
        });
        return merge(collectionViewer.viewChange, this.dataChange).pipe(map(() => this.data));
    }
    disconnect(collectionViewer) { }
    /** Handle expand/collapse behaviors */
    handleTreeControl(change) {
        console.log(change);
        if (change.added) {
            change.added.forEach((node) => {
                if (node.sorting) {
                    node.sorting = false;
                }
                else {
                    this.toggleNode(node, true);
                }
            });
        }
        if (change.removed) {
            change.removed
                .slice()
                .reverse()
                .forEach(node => this.toggleNode(node, false));
        }
    }
    /**
     * Toggle the node, remove from display list
     */
    toggleNode(node, expand) {
        const index = this.data.indexOf(node);
        if (expand) {
            console.log(this.nodeCache);
            let children;
            node.isLoading = true;
            const childrenCache = this.getCache(node);
            const $childrenRequest = childrenCache ? of(childrenCache) : this.treeService.getChildren(node);
            $childrenRequest.subscribe((childrenNames) => {
                children = childrenNames;
                if (!children || index < 0)
                    return;
                children.forEach(f => f.level = node.level + 1);
                this.data.splice(index + 1, 0, ...children);
                this.dataChange.next(this.data);
                node.isLoading = false;
                this.nodeCache.set(node, children);
            });
        }
        else {
            // 记录要移除的子节点数量
            let count = 0;
            for (let i = index + 1; i < this.data.length && this.data[i].level > node.level; i++, count++) { }
            this.data.splice(index + 1, count);
            this.dataChange.next(this.data);
        }
    }
    hasCache(node) {
        return Array.from(this.nodeCache.keys()).findIndex(f => f.id === node.id);
    }
    getCache(node) {
        const key = Array.from(this.nodeCache.keys()).find(f => f.id === node.id);
        return this.nodeCache.get(key);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1kYXRhLXNvdXJjZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2NvbW1vbi11aS1ubS9zcmMvbGliL3RyZWUvc29ydGFibGUtdHJlZS9keW5hbWljLWRhdGEtc291cmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0MsT0FBTyxFQUFjLGVBQWUsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUduRSxNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUcsSUFBSSxjQUFjLENBQWMsYUFBYSxDQUFDLENBQUE7QUFxQzFFLE1BQU0sT0FBTyxjQUFjO0lBT3pCLElBQUksSUFBSTtRQUNOLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUM7SUFDL0IsQ0FBQztJQUNELElBQUksSUFBSSxDQUFDLEtBQXdCO1FBQy9CLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztRQUNwQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM5QixDQUFDO0lBRUQsWUFDVSxZQUE4QztJQUN0RCxzQ0FBc0M7SUFDOUIsV0FBd0I7UUFGeEIsaUJBQVksR0FBWixZQUFZLENBQWtDO1FBRTlDLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBZmxDLGVBQVUsR0FBRyxJQUFJLGVBQWUsQ0FBb0IsRUFBRSxDQUFDLENBQUM7UUFDeEQsMkNBQTJDO1FBQ3BDLGNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBMEIsQ0FBQztJQWNqRCxDQUFDO0lBRUwsT0FBTyxDQUFDLGdCQUFrQztRQUN4QyxJQUFJLENBQUMsWUFBWSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQzFELElBQ0csTUFBMkMsQ0FB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QyxFQUNqQixDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFDdkQsQ0FBQyxFQUFFLEVBQUUsS0FBSyxFQUFFLEVBQ1osR0FBRztZQUNMLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDbkMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2pDO0lBRUgsQ0FBQztJQUVELFFBQVEsQ0FBQyxJQUFTO1FBQ2hCLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7SUFDM0UsQ0FBQztJQUVELFFBQVEsQ0FBQyxJQUFTO1FBQ2hCLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQ3pFLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDaEMsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGF0YVNvdXJjZSwgQ29sbGVjdGlvblZpZXdlciwgU2VsZWN0aW9uQ2hhbmdlIH0gZnJvbSBcIkBhbmd1bGFyL2Nkay9jb2xsZWN0aW9uc1wiO1xuaW1wb3J0IHsgRmxhdFRyZWVDb250cm9sIH0gZnJvbSBcIkBhbmd1bGFyL2Nkay90cmVlXCI7XG5pbXBvcnQgeyBJbmplY3Rpb25Ub2tlbiB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBCZWhhdmlvclN1YmplY3QsIG1lcmdlLCBtYXAsIG9mIH0gZnJvbSBcInJ4anNcIjtcblxuXG5leHBvcnQgY29uc3QgVFJFRV9TRVJWSUNFID0gbmV3IEluamVjdGlvblRva2VuPFRyZWVTZXJ2aWNlPigndHJlZVNlcnZpY2UnKVxuXG5leHBvcnQgaW50ZXJmYWNlIFRyZWVTZXJ2aWNlIHtcbiAgLyoqXG4gICAqIHsgcGFyZW50SWQ6IHN0cmluZywgYXBwSWQ6IHN0cmluZywgc29ydDogc3RyaW5nW10gfVxuICAgKiBAcGFyYW0gcGFyYW1zXG4gICAqL1xuICBnZXRDaGlsZHJlbihwYXJhbXM6IGFueSk6IE9ic2VydmFibGU8RHluYW1pY0ZsYXROb2RlW10+O1xuICBpbml0aWFsRGF0YSgpOiBPYnNlcnZhYmxlPER5bmFtaWNGbGF0Tm9kZVtdPjtcbiAgbW92ZShub2RlSWQ6IGFueSwgbmV4dE5vZGVJZDogYW55KTogT2JzZXJ2YWJsZTx2b2lkPjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEeW5hbWljRmxhdE5vZGUge1xuICBpZDogc3RyaW5nLFxuICBwYXJlbnRJZDogc3RyaW5nLFxuICBuYW1lPzogc3RyaW5nLFxuICBjb2RlPzogc3RyaW5nLFxuICBsZXZlbDogbnVtYmVyLFxuICBleHBhbmRhYmxlOiBib29sZWFuLFxuICBjaGlsZENvdW50OiBudW1iZXIsXG4gIGlzTG9hZGluZzogYm9vbGVhbixcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEeW5hbWljVHJlZU5vZGUge1xuICBpZDogc3RyaW5nLFxuICBtZTogYW55LFxuICBuYW1lPzogc3RyaW5nLFxuICBjb2RlPzogc3RyaW5nLFxuICBsZXZlbDogbnVtYmVyLFxuICBleHBhbmRhYmxlOiBib29sZWFuLFxuICBjaGlsZENvdW50OiBudW1iZXIsXG4gIGlzTG9hZGluZzogYm9vbGVhbixcbiAgY2hpbGRyZW46IER5bmFtaWNUcmVlTm9kZVtdXG59XG5cblxuXG5leHBvcnQgY2xhc3MgVHJlZURhdGFTb3VyY2UgaW1wbGVtZW50cyBEYXRhU291cmNlPER5bmFtaWNGbGF0Tm9kZT4ge1xuXG5cbiAgZGF0YUNoYW5nZSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8RHluYW1pY0ZsYXROb2RlW10+KFtdKTtcbiAgLyoqIOiKgueCuee8k+WtmO+8mmtleSDkuLrniLboioLngrkgaXRlbe+8jHZhbHVlIOS4uuWFtuWxleW8gOWQjueahOWtkOiKgueCueWIl+ihqCAqL1xuICBwdWJsaWMgbm9kZUNhY2hlID0gbmV3IE1hcDxhbnksIER5bmFtaWNGbGF0Tm9kZVtdPigpO1xuXG4gIGdldCBkYXRhKCk6IER5bmFtaWNGbGF0Tm9kZVtdIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhQ2hhbmdlLnZhbHVlO1xuICB9XG4gIHNldCBkYXRhKHZhbHVlOiBEeW5hbWljRmxhdE5vZGVbXSkge1xuICAgIHRoaXMuX3RyZWVDb250cm9sLmRhdGFOb2RlcyA9IHZhbHVlO1xuICAgIHRoaXMuZGF0YUNoYW5nZS5uZXh0KHZhbHVlKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgX3RyZWVDb250cm9sOiBGbGF0VHJlZUNvbnRyb2w8RHluYW1pY0ZsYXROb2RlPixcbiAgICAvLyBwcml2YXRlIF9kYXRhYmFzZTogRHluYW1pY0RhdGFiYXNlLFxuICAgIHByaXZhdGUgdHJlZVNlcnZpY2U6IFRyZWVTZXJ2aWNlLFxuICApIHsgfVxuXG4gIGNvbm5lY3QoY29sbGVjdGlvblZpZXdlcjogQ29sbGVjdGlvblZpZXdlcik6IE9ic2VydmFibGU8RHluYW1pY0ZsYXROb2RlW10+IHtcbiAgICB0aGlzLl90cmVlQ29udHJvbC5leHBhbnNpb25Nb2RlbC5jaGFuZ2VkLnN1YnNjcmliZShjaGFuZ2UgPT4ge1xuICAgICAgaWYgKFxuICAgICAgICAoY2hhbmdlIGFzIFNlbGVjdGlvbkNoYW5nZTxEeW5hbWljRmxhdE5vZGU+KS5hZGRlZCB8fFxuICAgICAgICAoY2hhbmdlIGFzIFNlbGVjdGlvbkNoYW5nZTxEeW5hbWljRmxhdE5vZGU+KS5yZW1vdmVkXG4gICAgICApIHtcbiAgICAgICAgdGhpcy5oYW5kbGVUcmVlQ29udHJvbChjaGFuZ2UgYXMgU2VsZWN0aW9uQ2hhbmdlPER5bmFtaWNGbGF0Tm9kZT4pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIG1lcmdlKGNvbGxlY3Rpb25WaWV3ZXIudmlld0NoYW5nZSwgdGhpcy5kYXRhQ2hhbmdlKS5waXBlKG1hcCgoKSA9PiB0aGlzLmRhdGEpKTtcbiAgfVxuXG4gIGRpc2Nvbm5lY3QoY29sbGVjdGlvblZpZXdlcjogQ29sbGVjdGlvblZpZXdlcik6IHZvaWQgeyB9XG5cbiAgLyoqIEhhbmRsZSBleHBhbmQvY29sbGFwc2UgYmVoYXZpb3JzICovXG4gIGhhbmRsZVRyZWVDb250cm9sKGNoYW5nZTogU2VsZWN0aW9uQ2hhbmdlPER5bmFtaWNGbGF0Tm9kZT4pIHtcbiAgICBjb25zb2xlLmxvZyhjaGFuZ2UpXG5cbiAgICBpZiAoY2hhbmdlLmFkZGVkKSB7XG4gICAgICBjaGFuZ2UuYWRkZWQuZm9yRWFjaCgobm9kZTogYW55KSA9PiB7XG4gICAgICAgIGlmIChub2RlLnNvcnRpbmcpIHtcbiAgICAgICAgICBub2RlLnNvcnRpbmcgPSBmYWxzZVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMudG9nZ2xlTm9kZShub2RlLCB0cnVlKVxuICAgICAgICB9XG5cbiAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAoY2hhbmdlLnJlbW92ZWQpIHtcbiAgICAgIGNoYW5nZS5yZW1vdmVkXG4gICAgICAgIC5zbGljZSgpXG4gICAgICAgIC5yZXZlcnNlKClcbiAgICAgICAgLmZvckVhY2gobm9kZSA9PiB0aGlzLnRvZ2dsZU5vZGUobm9kZSwgZmFsc2UpKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVG9nZ2xlIHRoZSBub2RlLCByZW1vdmUgZnJvbSBkaXNwbGF5IGxpc3RcbiAgICovXG4gIHRvZ2dsZU5vZGUobm9kZTogRHluYW1pY0ZsYXROb2RlLCBleHBhbmQ6IGJvb2xlYW4pIHtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuZGF0YS5pbmRleE9mKG5vZGUpO1xuICAgIGlmIChleHBhbmQpIHtcbiAgICAgIGNvbnNvbGUubG9nKHRoaXMubm9kZUNhY2hlKVxuICAgICAgbGV0IGNoaWxkcmVuOiBEeW5hbWljRmxhdE5vZGVbXTtcbiAgICAgIG5vZGUuaXNMb2FkaW5nID0gdHJ1ZTtcbiAgICAgIGNvbnN0IGNoaWxkcmVuQ2FjaGUgPSB0aGlzLmdldENhY2hlKG5vZGUpXG4gICAgICBjb25zdCAkY2hpbGRyZW5SZXF1ZXN0ID0gY2hpbGRyZW5DYWNoZSA/IG9mKGNoaWxkcmVuQ2FjaGUpIDogdGhpcy50cmVlU2VydmljZS5nZXRDaGlsZHJlbihub2RlKTtcbiAgICAgICRjaGlsZHJlblJlcXVlc3Quc3Vic2NyaWJlKChjaGlsZHJlbk5hbWVzOiBhbnkpID0+IHtcbiAgICAgICAgY2hpbGRyZW4gPSBjaGlsZHJlbk5hbWVzXG4gICAgICAgIGlmICghY2hpbGRyZW4gfHwgaW5kZXggPCAwKSByZXR1cm47XG4gICAgICAgIGNoaWxkcmVuLmZvckVhY2goZiA9PiBmLmxldmVsID0gbm9kZS5sZXZlbCArIDEpXG4gICAgICAgIHRoaXMuZGF0YS5zcGxpY2UoaW5kZXggKyAxLCAwLCAuLi5jaGlsZHJlbik7XG4gICAgICAgIHRoaXMuZGF0YUNoYW5nZS5uZXh0KHRoaXMuZGF0YSk7XG4gICAgICAgIG5vZGUuaXNMb2FkaW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMubm9kZUNhY2hlLnNldChub2RlLCBjaGlsZHJlbilcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIOiusOW9leimgeenu+mZpOeahOWtkOiKgueCueaVsOmHj1xuICAgICAgbGV0IGNvdW50ID0gMDtcbiAgICAgIGZvciAoXG4gICAgICAgIGxldCBpID0gaW5kZXggKyAxO1xuICAgICAgICBpIDwgdGhpcy5kYXRhLmxlbmd0aCAmJiB0aGlzLmRhdGFbaV0ubGV2ZWwgPiBub2RlLmxldmVsO1xuICAgICAgICBpKyssIGNvdW50KytcbiAgICAgICkgeyB9XG4gICAgICB0aGlzLmRhdGEuc3BsaWNlKGluZGV4ICsgMSwgY291bnQpO1xuICAgICAgdGhpcy5kYXRhQ2hhbmdlLm5leHQodGhpcy5kYXRhKTtcbiAgICB9XG5cbiAgfVxuXG4gIGhhc0NhY2hlKG5vZGU6IGFueSkge1xuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMubm9kZUNhY2hlLmtleXMoKSkuZmluZEluZGV4KGYgPT4gZi5pZCA9PT0gbm9kZS5pZClcbiAgfVxuXG4gIGdldENhY2hlKG5vZGU6IGFueSkge1xuICAgIGNvbnN0IGtleSA9IEFycmF5LmZyb20odGhpcy5ub2RlQ2FjaGUua2V5cygpKS5maW5kKGYgPT4gZi5pZCA9PT0gbm9kZS5pZClcbiAgICByZXR1cm4gdGhpcy5ub2RlQ2FjaGUuZ2V0KGtleSlcbiAgfVxufVxuIl19