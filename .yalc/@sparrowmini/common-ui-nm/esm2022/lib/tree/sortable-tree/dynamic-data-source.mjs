import { InjectionToken } from "@angular/core";
import { BehaviorSubject, merge, map } from "rxjs";
export const TREE_SERVICE = new InjectionToken('treeService');
export class TreeDataSource {
    get data() {
        return this.dataChange.value;
    }
    set data(value) {
        this._treeControl.dataNodes = value;
        this.dataChange.next(value);
    }
    constructor(_treeControl, 
    // private _database: DynamicDatabase,
    treeService) {
        this._treeControl = _treeControl;
        this.treeService = treeService;
        this.dataChange = new BehaviorSubject([]);
        /** 节点缓存：key 为父节点 item，value 为其展开后的子节点列表 */
        this.nodeCache = new Map();
    }
    connect(collectionViewer) {
        this._treeControl.expansionModel.changed.subscribe(change => {
            if (change.added ||
                change.removed) {
                this.handleTreeControl(change);
            }
        });
        return merge(collectionViewer.viewChange, this.dataChange).pipe(map(() => this.data));
    }
    disconnect(collectionViewer) { }
    /** Handle expand/collapse behaviors */
    handleTreeControl(change) {
        console.log(change);
        if (change.added) {
            change.added.forEach((node) => {
                if (node.sorting) {
                    node.sorting = false;
                }
                else {
                    this.toggleNode(node, true);
                }
            });
        }
        if (change.removed) {
            change.removed
                .slice()
                .reverse()
                .forEach(node => this.toggleNode(node, false));
        }
    }
    /**
     * Toggle the node, remove from display list
     */
    toggleNode(node, expand) {
        const index = this.data.indexOf(node);
        if (expand) {
            console.log(this.nodeCache);
            let children;
            node.isLoading = true;
            const $childrenRequest = this.treeService.getChildren(node);
            $childrenRequest.subscribe((childrenNames) => {
                children = childrenNames;
                if (!children || index < 0)
                    return;
                children.forEach(f => f.level = node.level + 1);
                this.data.splice(index + 1, 0, ...children);
                this.dataChange.next(this.data);
                node.isLoading = false;
                this.nodeCache.set(node.id, children);
            });
        }
        else {
            // 记录要移除的子节点数量
            let count = 0;
            for (let i = index + 1; i < this.data.length && this.data[i].level > node.level; i++, count++) { }
            this.data.splice(index + 1, count);
            this.dataChange.next(this.data);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1kYXRhLXNvdXJjZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2NvbW1vbi11aS1ubS9zcmMvbGliL3RyZWUvc29ydGFibGUtdHJlZS9keW5hbWljLWRhdGEtc291cmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0MsT0FBTyxFQUFjLGVBQWUsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFNLE1BQU0sTUFBTSxDQUFDO0FBR25FLE1BQU0sQ0FBQyxNQUFNLFlBQVksR0FBRyxJQUFJLGNBQWMsQ0FBYyxhQUFhLENBQUMsQ0FBQTtBQXFDMUUsTUFBTSxPQUFPLGNBQWM7SUFPekIsSUFBSSxJQUFJO1FBQ04sT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQztJQUMvQixDQUFDO0lBQ0QsSUFBSSxJQUFJLENBQUMsS0FBd0I7UUFDL0IsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFRCxZQUNVLFlBQThDO0lBQ3RELHNDQUFzQztJQUM5QixXQUF3QjtRQUZ4QixpQkFBWSxHQUFaLFlBQVksQ0FBa0M7UUFFOUMsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFmbEMsZUFBVSxHQUFHLElBQUksZUFBZSxDQUFvQixFQUFFLENBQUMsQ0FBQztRQUN4RCwyQ0FBMkM7UUFDcEMsY0FBUyxHQUFHLElBQUksR0FBRyxFQUEwQixDQUFDO0lBY2pELENBQUM7SUFFTCxPQUFPLENBQUMsZ0JBQWtDO1FBQ3hDLElBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDMUQsSUFDRyxNQUEyQyxDQUFDLEtBQUs7Z0JB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dkQsQ0FBQyxFQUFFLEVBQUUsS0FBSyxFQUFFLEVBQ1osR0FBRztZQUNMLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDbkMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2pDO0lBRUgsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGF0YVNvdXJjZSwgQ29sbGVjdGlvblZpZXdlciwgU2VsZWN0aW9uQ2hhbmdlIH0gZnJvbSBcIkBhbmd1bGFyL2Nkay9jb2xsZWN0aW9uc1wiO1xuaW1wb3J0IHsgRmxhdFRyZWVDb250cm9sIH0gZnJvbSBcIkBhbmd1bGFyL2Nkay90cmVlXCI7XG5pbXBvcnQgeyBJbmplY3Rpb25Ub2tlbiB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBCZWhhdmlvclN1YmplY3QsIG1lcmdlLCBtYXAsIG9mIH0gZnJvbSBcInJ4anNcIjtcblxuXG5leHBvcnQgY29uc3QgVFJFRV9TRVJWSUNFID0gbmV3IEluamVjdGlvblRva2VuPFRyZWVTZXJ2aWNlPigndHJlZVNlcnZpY2UnKVxuXG5leHBvcnQgaW50ZXJmYWNlIFRyZWVTZXJ2aWNlIHtcbiAgLyoqXG4gICAqIHsgcGFyZW50SWQ6IHN0cmluZywgYXBwSWQ6IHN0cmluZywgc29ydDogc3RyaW5nW10gfVxuICAgKiBAcGFyYW0gcGFyYW1zXG4gICAqL1xuICBnZXRDaGlsZHJlbihwYXJhbXM6IGFueSk6IE9ic2VydmFibGU8RHluYW1pY0ZsYXROb2RlW10+O1xuICBpbml0aWFsRGF0YSgpOiBPYnNlcnZhYmxlPER5bmFtaWNGbGF0Tm9kZVtdPjtcbiAgbW92ZShub2RlSWQ6IGFueSwgbmV4dE5vZGVJZDogYW55KTogT2JzZXJ2YWJsZTx2b2lkPjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEeW5hbWljRmxhdE5vZGUge1xuICBpZDogc3RyaW5nLFxuICBwYXJlbnRJZDogc3RyaW5nLFxuICBuYW1lPzogc3RyaW5nLFxuICBjb2RlPzogc3RyaW5nLFxuICBsZXZlbDogbnVtYmVyLFxuICBleHBhbmRhYmxlOiBib29sZWFuLFxuICBjaGlsZENvdW50OiBudW1iZXIsXG4gIGlzTG9hZGluZzogYm9vbGVhbixcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEeW5hbWljVHJlZU5vZGUge1xuICBpZDogc3RyaW5nLFxuICBtZTogYW55LFxuICBuYW1lPzogc3RyaW5nLFxuICBjb2RlPzogc3RyaW5nLFxuICBsZXZlbDogbnVtYmVyLFxuICBleHBhbmRhYmxlOiBib29sZWFuLFxuICBjaGlsZENvdW50OiBudW1iZXIsXG4gIGlzTG9hZGluZzogYm9vbGVhbixcbiAgY2hpbGRyZW46IER5bmFtaWNUcmVlTm9kZVtdXG59XG5cblxuXG5leHBvcnQgY2xhc3MgVHJlZURhdGFTb3VyY2UgaW1wbGVtZW50cyBEYXRhU291cmNlPER5bmFtaWNGbGF0Tm9kZT4ge1xuXG5cbiAgZGF0YUNoYW5nZSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8RHluYW1pY0ZsYXROb2RlW10+KFtdKTtcbiAgLyoqIOiKgueCuee8k+WtmO+8mmtleSDkuLrniLboioLngrkgaXRlbe+8jHZhbHVlIOS4uuWFtuWxleW8gOWQjueahOWtkOiKgueCueWIl+ihqCAqL1xuICBwdWJsaWMgbm9kZUNhY2hlID0gbmV3IE1hcDxhbnksIER5bmFtaWNGbGF0Tm9kZVtdPigpO1xuXG4gIGdldCBkYXRhKCk6IER5bmFtaWNGbGF0Tm9kZVtdIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhQ2hhbmdlLnZhbHVlO1xuICB9XG4gIHNldCBkYXRhKHZhbHVlOiBEeW5hbWljRmxhdE5vZGVbXSkge1xuICAgIHRoaXMuX3RyZWVDb250cm9sLmRhdGFOb2RlcyA9IHZhbHVlO1xuICAgIHRoaXMuZGF0YUNoYW5nZS5uZXh0KHZhbHVlKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgX3RyZWVDb250cm9sOiBGbGF0VHJlZUNvbnRyb2w8RHluYW1pY0ZsYXROb2RlPixcbiAgICAvLyBwcml2YXRlIF9kYXRhYmFzZTogRHluYW1pY0RhdGFiYXNlLFxuICAgIHByaXZhdGUgdHJlZVNlcnZpY2U6IFRyZWVTZXJ2aWNlLFxuICApIHsgfVxuXG4gIGNvbm5lY3QoY29sbGVjdGlvblZpZXdlcjogQ29sbGVjdGlvblZpZXdlcik6IE9ic2VydmFibGU8RHluYW1pY0ZsYXROb2RlW10+IHtcbiAgICB0aGlzLl90cmVlQ29udHJvbC5leHBhbnNpb25Nb2RlbC5jaGFuZ2VkLnN1YnNjcmliZShjaGFuZ2UgPT4ge1xuICAgICAgaWYgKFxuICAgICAgICAoY2hhbmdlIGFzIFNlbGVjdGlvbkNoYW5nZTxEeW5hbWljRmxhdE5vZGU+KS5hZGRlZCB8fFxuICAgICAgICAoY2hhbmdlIGFzIFNlbGVjdGlvbkNoYW5nZTxEeW5hbWljRmxhdE5vZGU+KS5yZW1vdmVkXG4gICAgICApIHtcbiAgICAgICAgdGhpcy5oYW5kbGVUcmVlQ29udHJvbChjaGFuZ2UgYXMgU2VsZWN0aW9uQ2hhbmdlPER5bmFtaWNGbGF0Tm9kZT4pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIG1lcmdlKGNvbGxlY3Rpb25WaWV3ZXIudmlld0NoYW5nZSwgdGhpcy5kYXRhQ2hhbmdlKS5waXBlKG1hcCgoKSA9PiB0aGlzLmRhdGEpKTtcbiAgfVxuXG4gIGRpc2Nvbm5lY3QoY29sbGVjdGlvblZpZXdlcjogQ29sbGVjdGlvblZpZXdlcik6IHZvaWQgeyB9XG5cbiAgLyoqIEhhbmRsZSBleHBhbmQvY29sbGFwc2UgYmVoYXZpb3JzICovXG4gIGhhbmRsZVRyZWVDb250cm9sKGNoYW5nZTogU2VsZWN0aW9uQ2hhbmdlPER5bmFtaWNGbGF0Tm9kZT4pIHtcbiAgICBjb25zb2xlLmxvZyhjaGFuZ2UpXG5cbiAgICBpZiAoY2hhbmdlLmFkZGVkKSB7XG4gICAgICBjaGFuZ2UuYWRkZWQuZm9yRWFjaCgobm9kZTogYW55KSA9PiB7XG4gICAgICAgIGlmIChub2RlLnNvcnRpbmcpIHtcbiAgICAgICAgICBub2RlLnNvcnRpbmcgPSBmYWxzZVxuICAgICAgICB9ZWxzZXtcbiAgICAgICAgICB0aGlzLnRvZ2dsZU5vZGUobm9kZSwgdHJ1ZSlcbiAgICAgICAgfVxuXG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKGNoYW5nZS5yZW1vdmVkKSB7XG4gICAgICBjaGFuZ2UucmVtb3ZlZFxuICAgICAgICAuc2xpY2UoKVxuICAgICAgICAucmV2ZXJzZSgpXG4gICAgICAgIC5mb3JFYWNoKG5vZGUgPT4gdGhpcy50b2dnbGVOb2RlKG5vZGUsIGZhbHNlKSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRvZ2dsZSB0aGUgbm9kZSwgcmVtb3ZlIGZyb20gZGlzcGxheSBsaXN0XG4gICAqL1xuICB0b2dnbGVOb2RlKG5vZGU6IER5bmFtaWNGbGF0Tm9kZSwgZXhwYW5kOiBib29sZWFuKSB7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmRhdGEuaW5kZXhPZihub2RlKTtcbiAgICBpZiAoZXhwYW5kKSB7XG4gICAgICBjb25zb2xlLmxvZyh0aGlzLm5vZGVDYWNoZSlcbiAgICAgIGxldCBjaGlsZHJlbjogRHluYW1pY0ZsYXROb2RlW107XG4gICAgICBub2RlLmlzTG9hZGluZyA9IHRydWU7XG4gICAgICBjb25zdCAkY2hpbGRyZW5SZXF1ZXN0ID0gdGhpcy50cmVlU2VydmljZS5nZXRDaGlsZHJlbihub2RlKTtcbiAgICAgICRjaGlsZHJlblJlcXVlc3Quc3Vic2NyaWJlKChjaGlsZHJlbk5hbWVzOiBhbnkpID0+IHtcbiAgICAgICAgY2hpbGRyZW4gPSBjaGlsZHJlbk5hbWVzXG4gICAgICAgIGlmICghY2hpbGRyZW4gfHwgaW5kZXggPCAwKSByZXR1cm47XG4gICAgICAgIGNoaWxkcmVuLmZvckVhY2goZiA9PiBmLmxldmVsID0gbm9kZS5sZXZlbCArIDEpXG4gICAgICAgIHRoaXMuZGF0YS5zcGxpY2UoaW5kZXggKyAxLCAwLCAuLi5jaGlsZHJlbik7XG4gICAgICAgIHRoaXMuZGF0YUNoYW5nZS5uZXh0KHRoaXMuZGF0YSk7XG4gICAgICAgIG5vZGUuaXNMb2FkaW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMubm9kZUNhY2hlLnNldChub2RlLmlkLCBjaGlsZHJlbilcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIOiusOW9leimgeenu+mZpOeahOWtkOiKgueCueaVsOmHj1xuICAgICAgbGV0IGNvdW50ID0gMDtcbiAgICAgIGZvciAoXG4gICAgICAgIGxldCBpID0gaW5kZXggKyAxO1xuICAgICAgICBpIDwgdGhpcy5kYXRhLmxlbmd0aCAmJiB0aGlzLmRhdGFbaV0ubGV2ZWwgPiBub2RlLmxldmVsO1xuICAgICAgICBpKyssIGNvdW50KytcbiAgICAgICkgeyB9XG4gICAgICB0aGlzLmRhdGEuc3BsaWNlKGluZGV4ICsgMSwgY291bnQpO1xuICAgICAgdGhpcy5kYXRhQ2hhbmdlLm5leHQodGhpcy5kYXRhKTtcbiAgICB9XG5cbiAgfVxufVxuIl19